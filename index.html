<!DOCTYPE html>
{% autoescape true %}
<html lang="en">
	<head>
		<link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
		<style>
			.bomb{
				background-color: white;
				padding: 20px;
				margin: 10px;
			}
			.markBomb{
				background-color: red;
				padding: 20px;
				margin: 10px;
			}
		</style>
	</head>
	<body>
		<script src="http://code.jquery.com/jquery.js"></script>

		<div id="game">
		</div>
		<div>
			<form>
				<input id="size" type="text" name="size" value="3">
				<input type="button"  value="play game" onclick="Game.init()">
			</form>
			<p id="bombNumber"></p>
			<p id="statement"></p>
			<p id="winNumber">win number: 0</p>
		</div>
		<script>
			var winNumber = 0;
			var Game ={
				init: function(){
					Game.config = {
						play: $('#game'),
						buttons: $('<button></button>'),
						bombArray: [],
						realBombNumber: 0,
						notBombNumber: 0
					};
					var gameSize = $("#size").val();
					$("#game").empty();
					$("#statement").empty();
					Game.setup(gameSize);
				},

				setup: function(gameSize){
					Game.createBombs(gameSize);
					Game.bombInit();
					Game.countBomb(gameSize);
				},

				createBombs: function(gameSize){
					var scale = gameSize*gameSize;
					while(scale){
						Game.config.play.append("<button></button>");
						if (scale % gameSize == 1){
							Game.config.play.append("<br />");
						}
						scale--;
					};
				},


				bombInit: function(){
					$('button').each(function(index){
						var r = Math.floor(Math.random() * 10) % 4 + 1;  // r = 1 is  bomb; r = 2 is not bomb
						var bomb = $(this);
						if ( r == 1){
							bomb.attr('name', "bombed");
							Game.config.bombArray [index] = r;
							Game.config.realBombNumber++;
						}
						else{
							bomb.attr('name', "not-bomb");
							Game.config.bombArray[index] = r;
							Game.config.notBombNumber++;
						}
						$(this).attr('id', "bomb" + index);
						$(this).attr("class", "bomb");
						$(this).data("bombState", "initialState");
						$(this).on('click', this, Game.clickState);
						$(this).on('contextmenu', this, Game.rightClickState);
					})
					$("#bombNumber").html("Bomb Number:" + Game.config.realBombNumber);
				},

				countBomb: function(gameSize){
					gameSize = parseInt(gameSize);
					$('button').each(function(index){
						var countNum = 0;
						if ((index  - gameSize) >= 0){
							if (Game.config.bombArray[index  - gameSize] == 1){
								countNum++;
							}
						}
						if ((index % gameSize) != 0){
							if (Game.config.bombArray[index - 1] == 1){
								countNum++;
							}
						}
						if ((index % gameSize) != (gameSize - 1) ){
							if(Game.config.bombArray[index + 1] == 1){
								countNum++;
							}
						}
						if ((index + gameSize) <= (gameSize*gameSize - 1)){
							if (Game.config.bombArray[index + gameSize] == 1){
								countNum++;
							}
						}
						if ((index - gameSize) >= 0 && (index % gameSize ) != 0){
							if(Game.config.bombArray[index -gameSize - 1] == 1){
								countNum++;
							}
						}
						if ((index - gameSize) >= 0 && (index % gameSize) != (gameSize - 1)){
							if(Game.config.bombArray[index - gameSize + 1] == 1){
								countNum++;
							}
						}
						if ((index + gameSize) <= (gameSize*gameSize - 1) && (index % gameSize) != 0){
							if (Game.config.bombArray[index + gameSize -1] == 1){
								countNum++;
							}
						}
						if ((index + gameSize) <= (gameSize*gameSize - 1) && (index % gameSize) != (gameSize - 1)){
							if (Game.config.bombArray[index + gameSize +1] == 1){
								countNum++;
							}
						}
						$(this).data('bombNumber',countNum);
					})
				},

				clickState: function(elem){
					elem = elem.data;
					if ($(elem).data("bombState") == "initialState" && $(elem).attr("name") == "not-bomb"){
						var id = parseInt($(elem).attr("id").replace("bomb",""));
						elem.innerHTML = $(elem).data("bombNumber");
						Game.config.notBombNumber--;
						Game.checkWin();
						$(elem).data("bombState", "openState");
					}else if ($(elem).data("bombState") == "initialState" && $(elem).attr("name") == "bombed"){
						$(elem).html("X");
						$(elem).data("bombState", "openState");
						$('#statement').html("YOU FAIL");
					}
				},

				rightClickState: function(elem){
					elem = elem.data;
					if ($(elem).data("bombState") == "initialState" ){
						$(elem).attr("class","");
						$(elem).attr("class","markBomb");

						if ($(elem).attr("name") == "bombed"){
							Game.config.realBombNumber--;
							Game.checkWin();
						}

						$(elem).data("bombState", "markState");
					}else if ($(elem).data("bombState") == "markState"){
						$(elem).attr("class","");
						$(elem).attr("class","bomb");

						if ($(elem).attr("name") == "bombed"){
							Game.config.realBombNumber++;
						}

						$(elem).data("bombState", "initialState");
					}
					return false;

				},

				checkWin: function(){
					if (Game.config.realBombNumber + Game.config.notBombNumber == 0){
						winNumber = winNumber + 1;
						$('#statement').html("YOU WIN");
						$('#winNumber').html("win number: " + winNumber);
					}
				}
			}

			$( document ).ready( Game.init );
		</script>
	</body>
</html>
{% endautoescape %}